# Prepares release information and branch, outputs release metadata
# Avoid passing `target_repo`, just used by sdk-actions itself
name: Release Preparation

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
        description: The new version being released (e.g., 5.2.15-beta.1)
      target_branch:
        required: false
        type: string
        description: The branch to target for the release branch creation
        default: main
      target_repo:
        required: false
        type: string
        description: FOR WRAPPERS ONLY. The repository to target for the release branch creation

    secrets:
      GH_PUSH_TOKEN:
        required: false
        description: GitHub token with push permissions

    outputs:
      release_branch:
        description: Name of the release branch
        value: ${{ jobs.prepare_release.outputs.release_branch }}

jobs:
  prepare_release:
    runs-on: ubuntu-latest
    outputs:
      release_branch: ${{ steps.release_branch.outputs.releaseBranch }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref:
            ${{ inputs.target_branch }}
            # To be set by callee since we have nested reusable workflows call which gets to set to the caller repo by default
            # But we need to create the release branch in the callee's repository
          repository: ${{ inputs.target_repo || github.repository }}
          token: ${{ secrets.GH_PUSH_TOKEN || github.token }}

      - name: Release branch name
        id: release_branch
        run: |
          # Use the full version including alpha/beta suffix
          echo "releaseBranch=rel/${{ inputs.version }}" >> $GITHUB_OUTPUT

      - name: Create release branch
        run: |
          releaseBranch="${{ steps.release_branch.outputs.releaseBranch }}"
          NEW_VERSION="${{ inputs.version }}"

          if ! git checkout -b "$releaseBranch" 2>/dev/null; then
            # Branch already exists
            if [[ ! "$NEW_VERSION" =~ -alpha ]] && [[ ! "$NEW_VERSION" =~ -beta ]]; then
              echo "Error: Release branch already exists for Current release"
              exit 1
            fi

            # For Alpha/Beta, use existing branch
            git checkout "$releaseBranch"
          fi
          git push -u origin "$releaseBranch"
